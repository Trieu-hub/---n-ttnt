<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Th√¥ng tin khoa - H·ªá th·ªëng g·ª£i √Ω m√¥n h·ªçc</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <nav class="breadcrumb" aria-label="breadcrumb" style="margin:16px;">
        <a href="index.html">üè† Trang ch·ªß</a> &nbsp;‚Ä∫&nbsp;
        <span id="bread-current">Khoa</span>
        <input type="text" id="mssv" placeholder="Nh·∫≠p MSSV...vd:IT001" style="margin-left:auto; padding:4px 6px; border-radius:4px; border:1px solid #ccc;" />
        <button id="loadBtn" style="padding:4px 8px; border-radius:4px; cursor:pointer;">G·ª£i √Ω m√¥n h·ªçc</button>
    </nav>

    <header id="faculty-header" class="faculty-header" role="banner" style="margin: 0 16px 18px 16px;">
        <div class="header-inner">
            <h1 id="faculty-name">T√™n khoa</h1>
            <p id="faculty-tagline" style="opacity:0.9;">M√¥ t·∫£ ng·∫Øn</p>
            <div id="faculty-meta" style="margin-top:10px; font-size:0.95rem; color:#444;">
                <span id="faculty-dean"></span>
                <span id="faculty-contact" style="margin-left:14px;"></span>
            </div>
        </div>
    </header>

    <main class="container" style="display:flex; gap:24px; align-items:flex-start; padding: 0 16px 40px;">
        <div class="main-content" style="flex:1; min-width:280px;">
            <section id="overview" class="card section-overview" aria-labelledby="overview-title">
                <h2 id="overview-title">T·ªïng quan</h2>
                <p id="faculty-overview">N·ªôi dung t·ªïng quan v·ªÅ khoa s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y.</p>
            </section>
            <section id="curriculum" class="card section-curriculum" aria-labelledby="curriculum-title" style="margin-top:18px;">
                <h2 id="curriculum-title">N·ªôi dung ch√≠nh & Ch∆∞∆°ng tr√¨nh</h2>
                <div id="programs"></div>
                <h3 style="margin-top:12px;">C√°c m√¥n h·ªçc g·ª£i √Ω</h3>
                <ul id="hot-courses" style="list-style: none; padding-left:0;"></ul>
            </section>
            <section id="research" class="card section-research" aria-labelledby="research-title" style="margin-top:18px;">
                <h2 id="research-title">Ph√≤ng th√≠ nghi·ªám & Nghi√™n c·ª©u</h2>
                <div id="labs-list"></div>
                <div id="research-areas" style="margin-top:10px;"></div>
            </section>
            <section id="career" class="card section-career" aria-labelledby="career-title" style="margin-top:18px;">
                <h2 id="career-title">C∆° h·ªôi ngh·ªÅ nghi·ªáp & H·ª£p t√°c doanh nghi·ªáp</h2>
                <div id="career-prospects"></div>
            </section>
        </div>
        <aside class="sidebar" style="width:320px; min-width:240px;">
            <div class="card" style="padding:14px;">
                <h3>C√°c m√¥n h·ªçc ƒë√£ h·ªçc</h3>
                <ul id="taken-courses" style="list-style:none; padding-left:0; margin-top:8px;"></ul>
            </div>
            <div class="card" style="padding:14px; margin-top:14px;">
                <h3>T√†i nguy√™n h·ªçc t·∫≠p</h3>
                <ul id="resources" style="list-style:none; padding-left:0; margin-top:8px;"></ul>
            </div>
            <div class="card" style="padding:14px; margin-top:14px;">
                <h3>Li√™n h·ªá & Th√¥ng tin</h3>
                <div id="contact-info" style="font-size:0.95rem; margin-top:8px;"></div>
            </div>
            <div class="card" style="padding:14px; margin-top:14px;">
                <h3>Chia s·∫ª / T√πy ch·ªçn</h3>
                <p style="font-size:0.9rem; color:#555;">B·∫°n c√≥ th·ªÉ copy ƒë∆∞·ªùng d·∫´n ho·∫∑c m·ªü b·∫£n in.</p>
                <button id="btn-copy-link" style="padding:8px 12px; border-radius:6px; cursor:pointer;">Sao ch√©p li√™n k·∫øt</button>
            </div>
        </aside>
    </main>

    <footer style="text-align:center; padding:18px 8px; color:#666;">
        ¬© HUTECH - H·ªá th·ªëng g·ª£i √Ω m√¥n h·ªçc ‚Äî Demo ƒë·ªì √°n
    </footer>

    <script src="./js/other/data.js"></script>
    <script>
    (function () {
        // debug logs
        console.log('Running faculty renderer...');
        // l·∫•y id khoa
        const params = new URLSearchParams(window.location.search);
        const fid = (params.get('id') || '');
        console.log('Requested id:', fid);

        // ki·ªÉm tra data load
        if (typeof faculties === 'undefined') {
            console.warn('Warning: data.js not loaded ho·∫∑c "faculties" undefined');
            window.faculties = {};
        }
        console.log('faculties keys:', Object.keys(window.faculties || {}));

        const data = window.faculties || {};
        const faculty = data[fid] || null;

        // n·∫øu kh√¥ng t·ªìn t·∫°i -> hi·ªÉn th·ªã h∆∞·ªõng d·∫´n
        if (!faculty) {
            document.getElementById('faculty-name').textContent = 'Kh√¥ng t√¨m th·∫•y khoa';
            document.getElementById('faculty-tagline').textContent = 'Vui l√≤ng ch·ªçn khoa t·ª´ trang ch√≠nh.';
            document.getElementById('bread-current').textContent = 'Kh√¥ng t√¨m th·∫•y';
            document.getElementById('overview-title').textContent = 'H∆∞·ªõng d·∫´n';
            document.getElementById('faculty-overview').textContent = 'B·∫°n c√≥ th·ªÉ quay l·∫°i trang ch·ªß v√† ch·ªçn m·ªôt khoa. V√≠ d·ª•: index.html';
            // list quick links n·∫øu c√≥ data
            if (Object.keys(data).length > 0) {
                const list = document.createElement('ul');
                list.style.listStyle = 'none';
                list.style.padding = 0;
                Object.keys(data).forEach(k => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="faculty.html?id=${k}">${data[k].name || k}</a>`;
                    list.appendChild(li);
                });
                document.getElementById('programs').appendChild(list);
            }
            return;
        }

        // Render th√¥ng tin faculty
        document.getElementById('bread-current').textContent = faculty.name || fid;
        document.getElementById('faculty-name').textContent = faculty.name || fid;
        document.getElementById('faculty-tagline').textContent = faculty.description || '';
        document.getElementById('faculty-overview').textContent = faculty.overview || "";

        // research labs
        const labsDiv = document.getElementById('labs-list');
        labsDiv.innerHTML = "";
        if (faculty.research?.labs) {
            const ul = document.createElement('ul');
            faculty.research.labs.forEach(lab => {
                const li = document.createElement('li');
                li.textContent = lab;
                ul.appendChild(li);
            });
            labsDiv.appendChild(ul);
        }

        // research areas
        document.getElementById('research-areas').textContent = faculty.research?.areas || "";

        // career
        document.getElementById('career-prospects').textContent = faculty.career_prospects || "";

        // resources
        const resUl = document.getElementById('resources');
        resUl.innerHTML = '';
        (faculty.resources || []).forEach(r => {
            const li = document.createElement('li');
            li.innerHTML = (r.url ? `<a href="${r.url}" target="_blank">${r.label || r}</a>` : (r.label || r));
            resUl.appendChild(li);
        });

        // contact
        const contactDiv = document.getElementById('contact-info');
        contactDiv.innerHTML = '';
        if (faculty.email) contactDiv.innerHTML += `<div><strong>Email:</strong> <a href="mailto:${faculty.email}">${faculty.email}</a></div>`;
        if (faculty.phone) contactDiv.innerHTML += `<div><strong>Hotline:</strong> ${faculty.phone}</div>`;
        if (faculty.website) contactDiv.innerHTML += `<div><strong>Website:</strong> <a href="${faculty.website}" target="_blank">${faculty.website}</a></div>`;

        // copy link
        document.getElementById('btn-copy-link').addEventListener('click', function () {
            navigator.clipboard?.writeText(window.location.href).then(()=>alert('ƒê√£ sao ch√©p li√™n k·∫øt'));
        });

        console.log('Render finished for', fid);
    })();

    function markAsLearned(courseName) {
        fetch("/move_course", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ student_id: currentMSSV, course_name: courseName })
        })
        .then(res => res.json())
        .then(data => alert(data.message));
        }

    // G·ªçi API Flask ƒë·ªÉ l·∫•y m√¥n h·ªçc ƒë√£ h·ªçc v√† m√¥n g·ª£i √Ω
    async function loadHotSubjects(student_id, facultyId, year) {
        try {
            let url = `http://127.0.0.1:5000/recommend/${encodeURIComponent(student_id)}/${encodeURIComponent(facultyId)}${year ? '/' + encodeURIComponent(year) : ''}`;
            const res = await fetch(url);
            const data = await res.json();

            console.log("API data:", data); // debug

            // Hi·ªÉn th·ªã m√¥n ƒë√£ h·ªçc
            const takenUl = document.getElementById("taken-courses");
            takenUl.innerHTML = "";

            // N·∫øu kh√¥ng c√≥ m√¥n n√†o ƒë√£ h·ªçc
            if (!data.taken || data.taken.length === 0) {
                const li = document.createElement("li");
                li.textContent = "Ch∆∞a c√≥ m√¥n n√†o ƒë∆∞·ª£c ho√†n th√†nh";
                li.style.color = "#999";
                li.style.fontStyle = "italic";
                takenUl.appendChild(li);
            } else {
                data.taken.forEach(subj => {
                    const li = document.createElement("li");
                    li.textContent = typeof subj === "string" ? subj : subj.course_name || JSON.stringify(subj);
                    takenUl.appendChild(li);
                });
            }

            // Hi·ªÉn th·ªã m√¥n g·ª£i √Ω (m·ªói item l√† object {course_id, course_name, score})
            const hotUl = document.getElementById("hot-courses");
            hotUl.innerHTML = "";
            (data.recommendations || []).forEach(item => {
                const li = document.createElement("li");
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.padding = "6px 0";

                const nameSpan = document.createElement("span");
                nameSpan.textContent = item.course_name || item.course_id;

                // th√™m n√∫t "Ho√†n th√†nh"
                const btn = document.createElement("button");
                btn.textContent = "‚úì Ho√†n th√†nh";
                btn.style.marginLeft = "10px";
                btn.style.padding = "4px 8px";
                btn.style.borderRadius = "4px";
                btn.style.cursor = "pointer";

                // khi click -> g·ªçi API update_status v·ªõi course_id (kh√¥ng d√πng t√™n)
                btn.addEventListener("click", async () => {
                    const studentId = document.getElementById("mssv").value.trim();
                    if (!studentId) {
                        alert("Vui l√≤ng nh·∫≠p MSSV tr∆∞·ªõc!");
                        return;
                    }

                    const course_id = item.course_id;
                    const new_status = "completed";

                    btn.disabled = true;
                    btn.textContent = "ƒêang c·∫≠p nh·∫≠t...";

                    try {
                        const res = await fetch(`http://127.0.0.1:5000/update_status/${studentId}/${course_id}/${facultyId}/${new_status}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ rating: 4.5 })  // G·ª≠i rating m·∫´u, b·∫°n c√≥ th·ªÉ thay b·∫±ng prompt ƒë·ªÉ nh·∫≠p rating
                        });

                        const result = await res.json();

                        if (!res.ok) {
                            alert(result.error || "C·∫≠p nh·∫≠t th·∫•t b·∫°i");
                            btn.disabled = false;
                            btn.textContent = "‚úì Ho√†n th√†nh";
                            return;
                        }

                        // C·∫≠p nh·∫≠t danh s√°ch ƒë√£ h·ªçc t·ª´ updated_courses
                        if (result.updated_courses) {
                            const takenUl = document.getElementById("taken-courses");
                            takenUl.innerHTML = "";
                            result.updated_courses
                                .filter(r => r.status && r.status.toLowerCase() === "completed")
                                .forEach(row => {
                                    const li2 = document.createElement("li");
                                    li2.textContent = row.course_name || row.course_id || "";
                                    takenUl.appendChild(li2);
                                });
                        }

                        // G·ªçi l·∫°i g·ª£i √Ω m·ªõi sau khi c·∫≠p nh·∫≠t
                        if (year) loadHotSubjects(studentId, facultyId, year);
                        else loadHotSubjects(studentId, facultyId);

                        alert(result.message || "ƒê√£ c·∫≠p nh·∫≠t!");
                    } catch (err) {
                        console.error(err);
                        alert("L·ªói k·∫øt n·ªëi t·ªõi server");
                        btn.disabled = false;
                        btn.textContent = "‚úì Ho√†n th√†nh";
                    }
                });

                li.appendChild(nameSpan);
                li.appendChild(btn);
                hotUl.appendChild(li);
            });

        } catch (err) {
            console.error("L·ªói khi g·ªçi API:", err);
            document.getElementById("hot-courses").innerHTML = "<li>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu g·ª£i √Ω.</li>";
        }
    }

    let facultyId = ""; 
    let year = null;

    window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        facultyId = params.get('id') || "";

        // L·∫•y s·∫µn studentId n·∫øu c√≥ (s·ª≠a id t·ª´ 'studentIdInput' th√†nh 'mssv')
        const studentId = document.getElementById('mssv')?.value?.trim() || "";

        if (studentId && studentId.includes("_")) {
            const parts = studentId.split("_"); 
            year = parts[2] || null;   // VD: IT_001_2 -> year = "2"
        }

        if (studentId) {
            if (year) {
                loadHotSubjects(studentId, facultyId, year);
            } else {
                loadHotSubjects(studentId, facultyId);
            }
        }
    });

    document.getElementById("loadBtn").addEventListener("click", () => {
        const studentId = document.getElementById("mssv").value.trim();
        if (!studentId) {
            alert("Vui l√≤ng nh·∫≠p MSSV!");
            return;
        }

        // C·∫≠p nh·∫≠t l·∫°i year khi nh·∫≠p MSSV m·ªõi
        year = null;
        if (studentId.includes("_")) {
            const parts = studentId.split("_");
            year = parts[2] || null;
        }

        console.log("G·ªçi API v·ªõi:", studentId, facultyId, year);
        if (year) {
            loadHotSubjects(studentId, facultyId, year);
        } else {
            loadHotSubjects(studentId, facultyId);
        }
    });
    </script>
</body>
</html>